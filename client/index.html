<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  </head>
  <body>
    <frc-dashboard edit-mode address-type="gitpod">
      <frc-sim-gitpod-info></frc-sim-gitpod-info>
      <frc-gyro></frc-gyro>
      <frc-sim-robot-state></frc-sim-robot-state>
      <frc-sim-fms></frc-sim-fms>

    </frc-dashboard>
    <script src="./node_modules/@frc-web-components/frc-web-components/build/frc-web-components.min.js"></script>

    <script>


        var socketOpen = false;
        var socket = null;
        const listeners = [];

        function getAddress(type) {
            return `wss://8082${window.location.href.substring(12)}ws`;
        }

        function createSocket(onMessage, onClose) {

            socket = new WebSocket(getAddress());
            if (socket) {
                socket.onopen = function () {
                    console.info("robot socket opened");
                    socketOpen = true;
                };

                socket.onmessage = function (msg) {
                    // var data = JSON.parse(msg.data);
                    // onMessage(data);
                    onMessage(msg.data);
                };

                socket.onclose = function () {
                    if (socketOpen) {
                        console.info("robot socket closed");
                        socket = null;
                        onClose();
                    }
                    // respawn the websocket
                    setTimeout(() => {
                        createSocket(onMessage, onClose);
                    }, 300);
                };
            }
        }

        function sendMsg(o) {
            if (socket) {
                var msg = JSON.stringify(o);
                socket.send(msg);
            }
        }

        createSocket(message => {
            console.log('robot message:', message);
        }, () => {});

    </script>


  </body>
</html>